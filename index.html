<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Daily Work Diary</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background-color: #f9f9f9;
      text-align: center; /* Center align all elements by default */
    }
    h1 {
      font-size: 2rem;
      margin-bottom: 10px;
    }
    .current-month-year {
      font-size: 1.2rem;
      margin-bottom: 20px;
      color: #4CAF50;
    }
    .calendar {
      border-collapse: collapse;
      width: 100%;
      margin: 0 auto;
      text-align: center; /* Ensure calendar cells are centered */
    }
    .calendar td,
    .calendar th {
      border: 1px solid #ddd;
      padding: 8px;
      vertical-align: top;
      height: 100px;
      text-align: center;
    }
    .day-header {
      color: white;
      font-weight: bold;
    }
    .date-cell {
      cursor: pointer;
    }
    .date-cell.monday {
      background-color: #ffe6e6;
    }
    .date-cell.tuesday {
      background-color: #fff3e6;
    }
    .date-cell.wednesday {
      background-color: #ffffe6;
    }
    .date-cell.thursday {
      background-color: #e6ffe6;
    }
    .date-cell.friday {
      background-color: #e6f7ff;
    }
    .date-cell.saturday {
      background-color: #e6e6ff;
    }
    .date-cell.sunday {
      background-color: #ffe6f2;
    }
    .date-cell:hover {
      opacity: 0.8;
    }
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
    }
    .modal-content {
      background-color: white;
      margin: 10% auto;
      padding: 20px;
      width: 90%;
      max-width: 600px;
      border-radius: 8px;
      text-align: left; /* Left-align modal content */
      position: relative;
    }
    .modal-content h2 {
      margin-top: 0;
    }
    .close-icon {
      position: absolute;
      top: 10px;
      right: 10px;
      font-size: 1.5rem;
      cursor: pointer;
      color: #f44336;
    }
    .form-group {
      margin-bottom: 15px;
    }
    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    .form-group input {
      width: 100%;
      padding: 10px;
      box-sizing: border-box;
    }
    .search-bar {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    .export-buttons {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin-top: 20px;
    }
    .export-buttons button {
      padding: 10px 20px;
      background-color: #008CBA;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    .export-buttons button:hover {
      background-color: #007B9E;
    }
    .report-table-container {
      max-height: 300px;
      overflow-y: auto;
      margin-top: 20px;
    }
    .report-table {
      width: 100%;
      border-collapse: collapse;
    }
    .report-table th,
    .report-table td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }
    /* Responsive Design */
    @media (max-width: 768px) {
      .modal-content {
        width: 95%;
        padding: 15px;
      }
      .export-buttons {
        flex-direction: column;
        align-items: center;
      }
    }
  </style>
</head>
<body>
  <!-- Centered Heading -->
  <h1>Daily Work Diary</h1>
  <div class="current-month-year" id="current-month-year"></div>

  <!-- Controls for Month/Year Dropdown -->
  <div class="controls">
    <select id="month-dropdown"></select>
    <select id="year-dropdown"></select>
    <button onclick="generateCalendar()">Go</button>
    <button onclick="openReportForm()">Reports</button>
  </div>

  <!-- Calendar -->
  <table class="calendar" id="calendar">
    <thead>
      <tr>
        <th class="day-header" style="background-color: #E44D26; color: white;">Monday</th>
        <th class="day-header" style="background-color: #0073AA; color: white;">Tuesday</th>
        <th class="day-header" style="background-color: #008000; color: white;">Wednesday</th>
        <th class="day-header" style="background-color: #FFA500; color: white;">Thursday</th>
        <th class="day-header" style="background-color: #005A9C; color: white;">Friday</th>
        <th class="day-header" style="background-color: #2E8B57; color: white;">Saturday</th>
        <th class="day-header" style="background-color: #E44D26; color: white;">Sunday</th>
      </tr>
    </thead>
    <tbody id="calendar-body">
      <!-- Calendar will be generated by JavaScript -->
    </tbody>
  </table>

  <!-- Modal for Form -->
  <div id="modal" class="modal">
    <div class="modal-content">
      <span class="close-icon" onclick="closeModal()">×</span>
      <h2>Daily Work Diary</h2>
      <form id="diary-form">
        <div class="form-group">
          <label>Date:</label>
          <input type="date" id="entry-date" required readonly />
        </div>
        <div class="form-group">
          <label>Station:</label>
          <input type="text" id="station" required />
        </div>
        <div class="form-group">
          <label>Object of Journey:</label>
          <input type="text" id="object" required />
        </div>
        <button type="button" onclick="saveEntry()">Save</button>
        <button type="button" onclick="clearForm()">Clear</button>
      </form>
    </div>
  </div>

  <!-- Report Modal -->
  <div id="report-modal" class="modal">
    <div class="modal-content">
      <span class="close-icon" onclick="closeReportForm()">×</span>
      <h2>Generate Reports</h2>
      <div class="search-bar">
        <div class="form-group">
          <label>From Date:</label>
          <input type="date" id="from-date" required />
        </div>
        <div class="form-group">
          <label>To Date:</label>
          <input type="date" id="to-date" required />
        </div>
        <div class="form-group">
          <label>Search by Station:</label>
          <input type="text" id="station-search" placeholder="Enter station name" />
        </div>
        <button onclick="generateReport()" style="width: 100%; padding: 10px; background-color: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer;">
          Generate Report
        </button>
      </div>
      <div class="export-buttons">
        <button onclick="exportToPDF()">Export to PDF</button>
        <button onclick="exportToExcel()">Export to Excel</button>
        <button onclick="exportToWord()">Export to Word</button>
      </div>
      <div class="report-table-container">
        <h3 id="report-heading">Daily Work Report</h3>
        <table class="report-table">
          <thead>
            <tr>
              <th>Date</th>
              <th>Station</th>
              <th>Object of Journey</th>
            </tr>
          </thead>
          <tbody id="report-table-body"></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    // Update the following constant with your Google Apps Script web app URL
    const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzGbp3ODUQs6veGSJPLJt4XDqYQTYSdEcD3h7STb4vXu3Lsn8aqFSiMgakVEueV6cktaA/exec';

    let currentYear = new Date().getFullYear();
    let currentMonth = new Date().getMonth();
    const months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];

    // Populate month and year dropdowns
    function populateDropdowns() {
      const monthDropdown = document.getElementById('month-dropdown');
      const yearDropdown = document.getElementById('year-dropdown');

      months.forEach((month, index) => {
        const option = document.createElement('option');
        option.value = index;
        option.text = month;
        monthDropdown.appendChild(option);
      });

      for (let year = 2020; year <= currentYear + 5; year++) {
        const option = document.createElement('option');
        option.value = year;
        option.text = year;
        yearDropdown.appendChild(option);
      }

      monthDropdown.value = currentMonth;
      yearDropdown.value = currentYear;
    }

    // Update the current month and year display
    function updateCurrentMonthYear() {
      const currentMonthYearElement = document.getElementById('current-month-year');
      currentMonthYearElement.textContent = `${months[currentMonth]} ${currentYear}`;
    }

    // Initialize calendar
    function generateCalendar() {
      currentMonth = parseInt(document.getElementById('month-dropdown').value);
      currentYear = parseInt(document.getElementById('year-dropdown').value);

      updateCurrentMonthYear(); // Update the displayed month and year

      const calendarBody = document.getElementById('calendar-body');
      calendarBody.innerHTML = '';
      const firstDayOfMonth = new Date(currentYear, currentMonth, 1).getDay(); // Day of the week for the 1st of the month (0 = Sunday)
      const lastDate = new Date(currentYear, currentMonth + 1, 0).getDate();

      // Adjust firstDayOfMonth to match Monday as the first day of the week
      let adjustedFirstDay = (firstDayOfMonth === 0 ? 6 : firstDayOfMonth - 1); // Convert Sunday = 0 to Monday = 0

      let date = 1;
      for (let i = 0; i < 6; i++) {
        const row = document.createElement('tr');
        for (let j = 0; j < 7; j++) {
          const cell = document.createElement('td');
          if ((i === 0 && j >= adjustedFirstDay) || (i > 0 && date <= lastDate)) {
            cell.className = `date-cell ${['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'][j]}`;
            cell.innerHTML = date;
            const formattedDate = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(date).padStart(2, '0')}`;
            cell.setAttribute('data-date', formattedDate);
            cell.onclick = () => openModal(formattedDate);
            loadEntry(cell, formattedDate);
            date++;
          }
          row.appendChild(cell);
        }
        calendarBody.appendChild(row);
      }
    }

    // Open modal and populate form fields
    function openModal(date) {
      const modal = document.getElementById('modal');
      const dateInput = document.getElementById('entry-date');
      dateInput.value = date;

      const entry = JSON.parse(localStorage.getItem(date));
      if (entry) {
        document.getElementById('station').value = entry.station;
        document.getElementById('object').value = entry.object;
      } else {
        document.getElementById('station').value = '';
        document.getElementById('object').value = '';
      }

      modal.style.display = 'block';
    }

    // Close modal
    function closeModal() {
      document.getElementById('modal').style.display = 'none';
    }

    // Clear form fields
    function clearForm() {
      document.getElementById('station').value = '';
      document.getElementById('object').value = '';
    }

    // Save entry to localStorage and Google Sheets; update calendar
    function saveEntry() {
      const date = document.getElementById('entry-date').value;
      const station = document.getElementById('station').value;
      const object = document.getElementById('object').value;

      if (!station || !object) {
        alert('All fields are required!');
        return;
      }

      const entry = { station, object };
      localStorage.setItem(date, JSON.stringify(entry));

      const cell = document.querySelector(`td[data-date="${date}"]`);
      if (cell) {
        cell.innerHTML = date;
        const entryDiv = document.createElement('div');
        entryDiv.className = 'entry';
        entryDiv.innerHTML = `<strong>${station}</strong><br>${object}`;
        cell.appendChild(entryDiv);
      }

      // Send entry to Google Sheets via the Google Apps Script web app
      fetch(GOOGLE_SCRIPT_URL, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          date: date,
          station: station,
          object: object
        })
      })
        .then(response => {
          console.log('Entry saved to Google Sheet');
        })
        .catch(error => {
          console.error('Error saving to Google Sheet:', error);
        });

      closeModal();
    }

    // Load saved entries from localStorage
    function loadEntry(cell, date) {
      const entry = JSON.parse(localStorage.getItem(date));
      if (entry) {
        const entryDiv = document.createElement('div');
        entryDiv.className = 'entry';
        entryDiv.innerHTML = `<strong>${entry.station}</strong><br>${entry.object}`;
        cell.appendChild(entryDiv);
      }
    }

    // Open report form
    function openReportForm() {
      document.getElementById('report-modal').style.display = 'block';
    }

    // Close report form
    function closeReportForm() {
      document.getElementById('report-modal').style.display = 'none';
    }

    // Generate report from localStorage entries (existing functionality)
    function generateReport() {
      const fromDate = document.getElementById('from-date').value;
      const toDate = document.getElementById('to-date').value;
      const stationSearch = document.getElementById('station-search').value.toLowerCase();
      const reportTableBody = document.getElementById('report-table-body');
      reportTableBody.innerHTML = '';

      if (!fromDate || !toDate) {
        alert('Please select both From Date and To Date.');
        return;
      }

      const fromDateObj = new Date(fromDate);
      const toDateObj = new Date(toDate);

      if ((toDateObj - fromDateObj) / (1000 * 60 * 60 * 24) > 90) {
        alert('Maximum report generation is 3 months.');
        return;
      }

      // Collect and sort entries by date
      const entries = [];
      for (let key in localStorage) {
        if (key.startsWith('20')) {
          const entryDate = new Date(key);
          if (entryDate >= fromDateObj && entryDate <= toDateObj) {
            const entry = JSON.parse(localStorage.getItem(key));
            if (!stationSearch || entry.station.toLowerCase().includes(stationSearch)) {
              const [year, month, day] = key.split('-');
              const formattedDate = `${day}-${month}-${year}`;
              entries.push({
                date: key,
                formattedDate: formattedDate,
                station: entry.station,
                object: entry.object
              });
            }
          }
        }
      }

      // Sort entries by date in ascending order
      entries.sort((a, b) => new Date(a.date) - new Date(b.date));

      // Display sorted entries in the table
      entries.forEach(entry => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${entry.formattedDate}</td>
          <td>${entry.station}</td>
          <td>${entry.object}</td>
        `;
        reportTableBody.appendChild(row);
      });

      // Update the report heading with the period
      const reportHeading = document.getElementById('report-heading');
      reportHeading.textContent = `Daily Work Report (${fromDate} to ${toDate})`;
    }

    // Export to PDF (using jsPDF)
    function exportToPDF() {
      const fromDate = document.getElementById('from-date').value;
      const toDate = document.getElementById('to-date').value;
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      // Add report title
      doc.setFontSize(16);
      doc.text(`Daily Work Report (${fromDate} to ${toDate})`, 10, 10);

      // Add table data
      const table = document.querySelector('.report-table');
      doc.autoTable({ html: table, startY: 20 });

      // Save the file with the period name
      const fileName = `Report_${fromDate}_${toDate}.pdf`;
      doc.save(fileName);
    }

    // Export to Excel (using SheetJS)
    function exportToExcel() {
      const fromDate = document.getElementById('from-date').value;
      const toDate = document.getElementById('to-date').value;
      const data = [['Date', 'Station', 'Object of Journey']];
      for (let key in localStorage) {
        if (key.startsWith('20')) {
          const entry = JSON.parse(localStorage.getItem(key));
          // Convert date format from yyyy-mm-dd to dd-mm-yyyy
          const [year, month, day] = key.split('-');
          const formattedDate = `${day}-${month}-${year}`;
          data.push([formattedDate, entry.station, entry.object]);
        }
      }
      const ws = XLSX.utils.aoa_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Report');
      const fileName = `Report_${fromDate}_${toDate}.xlsx`;
      XLSX.writeFile(wb, fileName);
    }

    // Export to Word (using Blob)
    function exportToWord() {
      const fromDate = document.getElementById('from-date').value;
      const toDate = document.getElementById('to-date').value;
      const table = document.querySelector('.report-table').outerHTML;
      const blob = new Blob([table], { type: 'application/msword' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      const fileName = `Report_${fromDate}_${toDate}.doc`;
      a.download = fileName;
      a.click();
    }

    // Initialize on load
    window.onload = () => {
      populateDropdowns();
      generateCalendar();
      updateCurrentMonthYear(); // Display the current month and year initially
    };
  </script>

  <!-- Include external libraries for PDF, Excel, and Word export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</body>
</html>
